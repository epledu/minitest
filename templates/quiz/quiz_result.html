{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="section">
    <p class="muted" style="margin: 0 0 6px;">분석 완료</p>
    <h1 class="page-title" style="margin-bottom: 16px;">{{ result.title }}</h1>

    <div style="margin-bottom: 16px;">
        {% if result.share_image %}
        <img src="{{ result.share_image.url }}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif result.share_image_url %}
        <img src="{{ result.share_image_url }}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif quiz.slug == "dopamine-test" %}
        <img src="{% static 'img/dopamin_answer.png' %}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif quiz.slug == "micro-spending" %}
        <img src="{% static 'img/micro_result.png' %}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif quiz.slug == "loneliness-management" %}
        <img src="{% static 'img/lonely_result.png' %}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif quiz.slug == "intentional-vs-optimization" %}
        <img src="{% static 'img/liquid_main.png' %}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif quiz.slug == "liquid-content" %}
        <img src="{% static 'img/content_main.png' %}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% elif quiz.thumbnail %}
        <img src="{{ quiz.thumbnail.url }}" alt="{{ result.title }}" class="card-media" style="border-radius: 20px;">
        {% endif %}
    </div>

    <article class="section" style="margin: 0 0 14px;">
        <h2 class="section-title" style="font-size: 22px; margin-bottom: 8px;">한 줄 요약</h2>
        <p class="page-subtitle">"{{ result.one_liner }}"</p>
        <p class="muted" style="margin-top: 12px;">{{ result.description }}</p>
    </article>

    <article class="section" style="margin: 0 0 14px;">
        <h2 class="section-title" style="font-size: 22px; margin-bottom: 8px;">{{ result.mission_label }}</h2>
        <p class="muted">{{ result.mission }}</p>
        <p class="muted" style="margin-top: 8px;">작은 행동 하나가 리듬을 바꿉니다. 오늘 바로 시작해 보세요.</p>
    </article>

    {% if rarity %}
    <article class="section" style="margin: 0 0 14px;">
        <h2 class="section-title" style="font-size: 22px; margin-bottom: 8px;">희소성 인사이트</h2>
        <p class="muted">이 결과는 전체 응답 중 약 {{ rarity }}%에서 나타나는 패턴으로 추정됩니다.</p>
        <p class="muted">실제 통계가 누적되기 전까지는 참고 수치로 제공됩니다.</p>
    </article>
    {% endif %}

    {% if match_result %}
    <article class="section" style="margin: 0 0 14px;">
        <h2 class="section-title" style="font-size: 22px; margin-bottom: 8px;">환상의 짝꿍 타입</h2>
        <p class="muted">당신과 균형이 잘 맞는 타입은 <strong>{{ match_result.title }}</strong> 입니다.</p>
    </article>
    {% endif %}

    {% if show_ads %}
    <div class="ad-container">
        <span class="ad-label">광고</span>
        <ins class="adsbygoogle" style="display:block" data-ad-format="fluid"></ins>
    </div>
    {% endif %}

    <article class="section" style="margin: 0 0 14px;">
        <h2 class="section-title" style="font-size: 22px; margin-bottom: 8px;">결과 활용 가이드</h2>
        <ul class="muted" style="margin: 10px 0 0 18px;">
            <li>오늘 할 수 있는 작은 행동 하나부터 실행해 보세요.</li>
            <li>일주일 뒤 같은 테스트를 다시 진행하면 변화가 보입니다.</li>
            <li>친구와 비교하면 나의 패턴을 더 잘 이해할 수 있습니다.</li>
        </ul>
    </article>

    <div style="display: grid; gap: 10px;">
        <button onclick="shareKakao()"
                data-share-image="{% if result_share_image_url %}{{ result_share_image_url }}{% elif quiz.slug == 'dopamine-test' %}{% static 'img/kakao_share.png' %}{% elif quiz.slug == 'micro-spending' %}{% static 'img/micro_kakao.png' %}{% elif quiz.slug == 'loneliness-management' %}{% static 'img/lonely_kakao.png' %}{% elif quiz.slug == 'intentional-vs-optimization' %}{% static 'img/liquid_main.png' %}{% elif quiz.slug == 'liquid-content' %}{% static 'img/content_main.png' %}{% elif quiz.slug == 'travel-soul-test' and quiz.thumbnail %}{{ request.scheme }}://{{ request.get_host }}{{ quiz.thumbnail.url }}{% else %}{{ kakao_share_image_url }}{% endif %}"
                class="btn-secondary"
                style="width: 100%;">
            카카오톡으로 결과 공유하기
        </button>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <a class="btn-primary" href="{% url 'quiz:quiz_list' %}">다른 테스트 보기</a>
            <a class="btn-ghost" href="{% url 'quiz:quiz_guide' quiz.slug %}">이 테스트 해설 보기</a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    function shareKakao() {
        if (!window.Kakao || !Kakao.isInitialized()) {
            alert("카카오 SDK 초기화가 필요합니다. KAKAO_JS_KEY를 확인해 주세요.");
            return;
        }
        const button = document.querySelector("[data-share-image]");
        const shareImage = button ? button.getAttribute("data-share-image") : "";

        Kakao.Share.sendDefault({
            objectType: "feed",
            content: {
                title: "{{ result.title }}",
                description: "{{ result.one_liner }}",
                imageUrl: shareImage || "{{ result_share_image_url }}" || "{{ result.share_image_url }}" || "{{ kakao_share_image_url }}",
                link: {
                    mobileWebUrl: window.location.href,
                    webUrl: window.location.href
                }
            },
            buttons: [
                {
                    title: "테스트 하러가기",
                    link: {
                        mobileWebUrl: window.location.origin,
                        webUrl: window.location.origin
                    }
                }
            ]
        });
    }
</script>
{% endblock %}
